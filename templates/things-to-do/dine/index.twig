{% set isAjax = craft.app.request.isAjax %}
{% extends isAjax ? '_layouts/ajax' : '_layouts/default' %}

{% set costFilter = craft.app.request.getParam('cost') %}
{% set cuisineFilter = craft.app.request.getParam('cuisine') %}
{% set areasFilter = craft.app.request.getParam('areas') %}
{% set restaurantQuery = craft.app.get('restaurants').filter({
    cost: costFilter, 
    cuisine: cuisineFilter,
    areas: areasFilter,
    orderBy: 'title asc'
}) %}

{% set cuisines = craft.entries.section('cuisines').all %}
{% set costs = craft.entries.section('costs').orderBy('title desc').all %}
{% set areas = craft.entries.section('areas').orderBy('title asc').all %}

{% block content %}
    {% if isAjax %}
        {% set showPlaces = [] %}
        {% for place in restaurantQuery.all %}
            {% if place.location is not empty %}
                {% set showPlaces = showPlaces |merge([place.location]) %}
            {% endif %}
        {% endfor %}
        {{ showPlaces | json_encode | raw }}
    {% else %}
        {% include '_partials/wysiwyg' with {
            content : {
                sectionHeading: 'Dine',
                copy: ''
            }
        } only %}
        
        {% include 'things-to-do/listingFilter' with {
            type: 'things-to-do/dine',
            cuisines: cuisines,
            costs: costs,
            areas: areas,
        } only %}

        {% include '_partials/map' with {
            places: restaurantQuery.all(),
        } only %}
    {% endif %}
{% endblock %}